{% extends 'core/base.html' %}
{% load humanize %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/postdetail.css' %}">
{% endblock %}

{% block head_extra %}
<!-- Open Graph Meta Tags -->
<meta property="og:title" content="{{ post.title }}" />
<meta property="og:description" content="{{ post.content|striptags|truncatewords:30 }}" />
<meta property="og:image" content="{% if post.image %}{{ request.scheme }}://{{ request.get_host }}{{ post.image.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/og-default-image.png' %}{% endif %}" />
<meta property="og:url" content="{{ request.build_absolute_uri }}" />
<meta property="og:type" content="article" />
<meta property="og:site_name" content="Blogunuzun AdÄ±" />

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ post.title }}">
<meta name="twitter:description" content="{{ post.content|striptags|truncatewords:30 }}">
<meta name="twitter:image" content="{% if post.image %}{{ request.scheme }}://{{ request.get_host }}{{ post.image.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/og-default-image.png' %}{% endif %}">
{% endblock %}

{% block content %}

<!-- Hero Image -->
{% if post.image %}
<div class="hero-image">
    <img src="{{ post.image.url }}" alt="{{ post.title }}">
    <div class="hero-overlay">
        <div class="article-container">
            <h1 class="article-title text-white">{{ post.title }}</h1>
        </div>
    </div>
</div>
{% endif %}

<!-- Article Content -->
<article class="article-container">
    {% if not post.image %}
    <div class="article-header">
        <h1 class="article-title">{{ post.title }}</h1>
    </div>
    {% endif %}

    <div class="article-meta">
        <div class="d-flex align-items-center">
            <img src="{% static 'images/default-avatar.png' %}" class="author-avatar" alt="{{ post.author }}">
            <div class="author-info ms-3">
                <span class="author-name">{{ post.author }}</span>
                <span class="article-date"><i class="far fa-calendar me-1"></i>{{ post.date_posted|naturaltime }}</span>
            </div>
        </div>

    </div>

    <div class="article-content">
        {{ post.content|safe }}
    </div>

    <div class="article-footer">
        <div class="d-flex justify-content-between align-items-center py-3 border-top">
            <div class="article-share">
                <span class="text-secondary me-2">PaylaÅŸ:</span>
                <!-- Twitter -->
                <a href="https://twitter.com/intent/tweet?text={{ blog_post.title|urlencode }}&url={{ request.build_absolute_uri }}"
                    target="_blank" class="text-secondary me-2">
                    <i class="fab fa-twitter"></i>
                </a>

                <!-- Facebook -->
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank"
                    class="text-secondary me-2">
                    <i class="fab fa-facebook"></i>
                </a>

                <!-- LinkedIn -->
                <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.build_absolute_uri }}&title={{ blog_post.title|urlencode }}&summary={{ blog_post.summary|default_if_none:''|urlencode }}&source=SiteAdÄ±"
                    target="_blank" class="text-secondary me-2">
                    <i class="fab fa-linkedin"></i>
                </a>

                <!-- Kopyala -->
                <a href="#"
                    onclick="navigator.clipboard.writeText('{{ request.build_absolute_uri }}'); alert('Link kopyalandÄ±!');"
                    class="text-secondary">
                    <i class="fas fa-link"></i>
                </a>
            </div>

            <div class="article-actions">
                <button class="btn btn-outline">
                    <i class="far fa-bookmark me-1"></i>Kaydet
                </button>
            </div>
        </div>
    </div>
</article>

<!-- Comments Section -->
<div class="article-container">
    <section class="comments-section">
        <h2 class="section-title">Yorumlar ({{ comments.count }})</h2>

        {% if comments.count == 0 %}
        <div class="empty-state">
            <div class="empty-state-icon">ðŸ’¬</div>
            <h3>HenÃ¼z yorum yok</h3>
            <p class="text-secondary">Ä°lk yorumu siz yaparak sohbete katÄ±lÄ±n</p>
        </div>
        {% endif %}

        <div class="comment-list">
            {% for comment in comments %}
            <div class="comment-item">
                <div class="comment-header">
                    <img src="{% static 'images/default-avatar.png' %}" class="comment-avatar" alt="{{ comment.name }}">
                    <div class="comment-meta">
                        <div class="comment-author">{{ comment.name }}</div>
                        <div class="comment-date">{{ comment.created_at|naturaltime }}</div>
                    </div>
                </div>

                <div class="comment-content">
                    {{ comment.content|linebreaks }}
                </div>

                <button class="reply-btn" data-comment-id="{{ comment.id }}">
                    <i class="fas fa-reply"></i> YanÄ±tla
                </button>

                <!-- Reply Form (Hidden) -->
                <div id="reply-form-{{ comment.id }}" class="reply-form" style="display: none;">
                    <h4 class="mb-3">YanÄ±t Yaz</h4>
                    <form method="POST" action="{% url 'core:post_detail' post.slug %}">
                        {% csrf_token %}
                        <input type="hidden" name="parent_id" value="{{ comment.id }}">

                        <div class="row">
                            <div class="col-md-6">
                                <label for="id_name_{{ comment.id }}" class="form-label">AdÄ±nÄ±z</label>
                                <input type="text" name="name" class="form-control" id="id_name_{{ comment.id }}"
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label for="id_email_{{ comment.id }}" class="form-label">Email</label>
                                <input type="email" name="email" class="form-control" id="id_email_{{ comment.id }}"
                                    required>
                            </div>
                        </div>

                        <div>
                            <label for="id_content_{{ comment.id }}" class="form-label">YanÄ±tÄ±nÄ±z</label>
                            <textarea name="content" class="form-control" id="id_content_{{ comment.id }}" rows="3"
                                required></textarea>
                        </div>

                        <div class="captcha">
                            {{ form.captcha }}
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <button type="button" class="btn btn-outline cancel-reply"
                                data-comment-id="{{ comment.id }}">
                                Ä°ptal
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-1"></i> GÃ¶nder
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Replies -->
                {% for reply in comment.replies.all %}
                <div class="reply-item mt-3">
                    <div class="comment-header">
                        <img src="{% static 'images/default-avatar.png' %}" class="comment-avatar"
                            alt="{{ reply.name }}">
                        <div class="comment-meta">
                            <div class="comment-author">{{ reply.name }}</div>
                            <div class="comment-date">{{ reply.created_at|naturaltime }}</div>
                        </div>
                    </div>

                    <div class="comment-content">
                        {{ reply.content|linebreaks }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <!-- Main Comment Form -->
        <div class="comment-form">
            <h3 class="section-title">Yorum Yap</h3>

            {% if form.errors %}
            <div class="alert alert-danger">
                <ul class="mb-0">
                    {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <form method="POST" action="{% url 'core:post_detail' post.slug %}">
                {% csrf_token %}

                <div class="row">
                    <div class="col-md-6">
                        <label for="id_name" class="form-label">AdÄ±nÄ±z</label>
                        <input type="text" name="name" class="form-control" id="id_name" required>
                    </div>
                    <div class="col-md-6">
                        <label for="id_email" class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" id="id_email" required>
                    </div>
                </div>

                <div>
                    <label for="id_content" class="form-label">Yorumunuz</label>
                    <textarea name="content" class="form-control" id="id_content" rows="5" required></textarea>
                </div>

                <div class="form-check">
                    <input type="checkbox" name="subscribe_newsletter" class="form-check-input"
                        id="id_subscribe_newsletter">
                    <label class="form-check-label" for="id_subscribe_newsletter">
                        Yeni gÃ¶nderilerden e-posta ile haberdar olmak istiyorum
                    </label>
                </div>

                <div class="captcha">
                    {{ form.captcha }}
                </div>

                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-paper-plane me-2"></i>Yorumu GÃ¶nder
                </button>
            </form>
        </div>
    </section>
</div>

{% endblock %}

{% block extra_js %}
<script>

        // Reply form management
        document.querySelectorAll('.reply-btn').forEach(button => {
            button.addEventListener('click', function () {
                const commentId = this.dataset.commentId;
                const form = document.getElementById(`reply-form-${commentId}`);

                // Close all other reply forms
                document.querySelectorAll('.reply-form').forEach(f => {
                    if (f.id !== `reply-form-${commentId}`) {
                        f.style.display = 'none';
                    }
                });

                // Toggle current form
                if (form.style.display === 'block') {
                    form.style.display = 'none';
                } else {
                    form.style.display = 'block';
                    form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        });

        // Cancel reply buttons
        document.querySelectorAll('.cancel-reply').forEach(button => {
            button.addEventListener('click', function () {
                const commentId = this.dataset.commentId;
                const form = document.getElementById(`reply-form-${commentId}`);
                form.style.display = 'none';
            });
        });

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
</script>
{% endblock %}